# Client Visibility Control Feature

## Summary
Implemented a granular client visibility control feature that allows specifying which users (lawyers) can see specific clients. This enhances privacy and access control within the Watheeq system.

## Changes Made

### Database Schema
- Added many-to-many relationship between [Client](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/types/index.ts#76-95) and [User](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/types/index.ts#26-40) models via `visibleToUsers` relation
- Created `_ClientVisibility` join table through Prisma migration

### Backend Changes

#### [create-client.dto.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/clients/dto/create-client.dto.ts)
- Added `visibleToUserIds?: string[]` field for specifying visible users

#### [clients.service.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/clients/clients.service.ts)
- [findAll()](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/users/users.controller.ts#72-78) - Filters clients for lawyers based on `visibleToUsers` relation
- [findOne()](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/clients/clients.service.ts#112-195) - Checks visibility permissions for lawyers
- [create()](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/users/users.controller.ts#97-103) - Connects specified users to client visibility
- [update()](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/users/users.controller.ts#109-116) - Updates visibility user list

#### [clients.controller.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/clients/clients.controller.ts)
- Added `@CurrentUser` decorators to pass userId and userRole to service methods

### Frontend Changes

#### [ClientForm.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/components/clients/ClientForm.tsx)
- Added `visibleToUserIds` to form schema
- Added lawyers prop and multi-select checkbox list for user visibility

#### [CreateClientPage.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/clients/CreateClientPage.tsx) & [EditClientPage.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/clients/EditClientPage.tsx)
- Fetch lawyers using [useLawyers()](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/hooks/useUsers.ts#15-26) hook
- Pass lawyers list and visibleToUserIds to ClientForm

#### [types/index.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/types/index.ts) & [use-clients.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/hooks/use-clients.ts)
- Added `visibleToUserIds` to [CreateClientRequest](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/types/index.ts#96-108) type
- Updated mutation hooks to use correct types

## Verification
- ✅ Backend build successful
- ✅ Frontend build successful
- ✅ Prisma migration applied

## Usage
When creating or editing a client, OWNER/ADMIN can now select specific lawyers who will have access to view that client's data. Lawyers will only see clients explicitly assigned to them.

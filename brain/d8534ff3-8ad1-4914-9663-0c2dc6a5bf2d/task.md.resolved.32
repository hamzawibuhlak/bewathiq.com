# Phase 34: Advanced RBAC System

## Database
- [ ] Add `CustomRole`, `RolePermission` models and `AccessLevel` enum to [schema.prisma](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/prisma/schema.prisma)
- [ ] Add `customRoleId` field & relation to `SuperAdminUser`
- [ ] Run migration & seed system roles (Owner, Manager, Support)

## Backend Services
- [ ] Create `roles.service.ts` — CRUD for custom roles
- [ ] Create `permission.service.ts` — Permission checking logic
- [ ] Create `permission.guard.ts` — NestJS guard
- [ ] Create `require-permission.decorator.ts`
- [ ] Update [super-admin.controller.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/super-admin/super-admin.controller.ts) — Add role endpoints + permission decorators
- [ ] Update [super-admin.module.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/super-admin/super-admin.module.ts) — Register new providers
- [ ] Update [super-admin-auth.service.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/super-admin/super-admin-auth.service.ts) — Include permissions in JWT/getMe
- [ ] Update [staff.service.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/super-admin/staff.service.ts) — Use customRoleId, remove hardcoded map

## Frontend
- [ ] Add roles API methods to [superAdmin.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/api/superAdmin.ts)
- [ ] Update [superAdmin.store.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/stores/superAdmin.store.ts) — Add permissions state + `hasPermission` helper
- [ ] Create `PermissionsMatrix.tsx` component
- [ ] Create `RolesListPage.tsx`
- [ ] Create `RoleEditorPage.tsx`
- [ ] Update [SALayout.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/super-admin/SALayout.tsx) — Add roles nav item + permission filtering
- [ ] Update [App.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/App.tsx) — Add roles routes

## Verification
- [ ] Test migration & seed
- [ ] Test permission guard blocks unauthorized actions
- [ ] Test UI: create role, assign, verify access control
- [ ] Deploy to production

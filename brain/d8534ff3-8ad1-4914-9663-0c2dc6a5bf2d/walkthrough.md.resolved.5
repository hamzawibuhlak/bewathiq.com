# Phase 27 — Owner Role Separation (Walkthrough)

## What Was Built

Phase 27 separates the **Company Owner** role from daily admin tasks by giving OWNER users their own dedicated dashboard at `/owner`.

---

## Backend Changes

### Schema Updates ([schema.prisma](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/prisma/schema.prisma))
- Added `ACCOUNTANT` to [UserRole](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/owner/owner.service.ts#104-129) enum
- Added [CompanyProfile](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/api/owner.api.ts#7-9) model (legal info, branding, settings)
- Added `TenantIntegration` model with `IntegrationType` enum (SMTP, SendGrid, WhatsApp, NAFATH, ZATCA, etc.)
- Added relations on [Tenant](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/super-admin/super-admin.controller.ts#24-25) model

### Guards & Decorators
- [OwnerGuard](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/auth/guards/owner.guard.ts) — Restricts to `OWNER` role only
- [@OwnerOnly()](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/auth/decorators/owner.decorator.ts) — Combines [JwtAuthGuard](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/auth/guards/jwt-auth.guard.ts#5-25) + [OwnerGuard](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/auth/guards/owner.guard.ts#3-15)

### Owner Module
| File | Purpose |
|------|---------|
| [owner.service.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/owner/owner.service.ts) | Business logic: company profile, users, integrations, workflows, billing, usage stats |
| [owner.controller.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/owner/owner.controller.ts) | REST endpoints at `/owner/*`, all protected by `@OwnerOnly()` |
| [owner.module.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/owner/owner.module.ts) | Module registered in [app.module.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/app.module.ts) |

### API Endpoints
| Method | Path | Description |
|--------|------|-------------|
| GET | `/owner/dashboard` | Dashboard stats |
| GET/PATCH | `/owner/company` | Company profile |
| GET | `/owner/users` | List users |
| POST | `/owner/users/invite` | Create user with temp password |
| PATCH | `/owner/users/:id/role` | Change user role |
| PATCH | `/owner/users/:id/toggle` | Toggle active/inactive |
| DELETE | `/owner/users/:id` | Soft-delete user |
| GET | `/owner/integrations` | List available integrations |
| POST | `/owner/integrations/:type` | Save integration config |
| POST | `/owner/integrations/:type/test` | Test integration |
| PATCH | `/owner/integrations/:type/toggle` | Toggle on/off |
| GET/POST | `/owner/workflows` | List/create workflows |
| PATCH | `/owner/workflows/:id/toggle` | Toggle workflow |
| DELETE | `/owner/workflows/:id` | Delete workflow |
| GET | `/owner/billing` | Subscription + invoices |
| GET | `/owner/usage` | Resource usage stats |

---

## Frontend Changes

### New Files
| File | Description |
|------|-------------|
| [owner.api.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/api/owner.api.ts) | API client for all owner endpoints |
| [OwnerLayout.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/owner/OwnerLayout.tsx) | Amber-themed sidebar layout |
| [OwnerDashboard.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/owner/OwnerDashboard.tsx) | Stats cards + usage meters |
| [CompanyProfilePage.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/owner/CompanyProfilePage.tsx) | Legal info, contact, branding form |
| [UsersManagementPage.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/owner/UsersManagementPage.tsx) | User table + invite modal + role change |
| [IntegrationsPage.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/owner/IntegrationsPage.tsx) | Integration cards with test/toggle |
| [WorkflowsPage.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/owner/WorkflowsPage.tsx) | Workflow list + create modal |
| [BillingPage.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/owner/BillingPage.tsx) | Subscription plan + invoices |

### Modified Files
- [App.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/App.tsx) — Added `/owner` routes + role-based redirect
- [auth.store.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/stores/auth.store.ts) — Added `SUPER_ADMIN` + `ACCOUNTANT` to role type

---

## Deployment Steps

```bash
# 1. Generate Prisma client
cd backend && npx prisma generate

# 2. Create + apply migration
npx prisma migrate dev --name phase-27-owner-panel

# 3. Build and deploy
npm run build
```

> [!IMPORTANT]
> The `(this.prisma as any)` casts in [owner.service.ts](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/backend/src/owner/owner.service.ts) are needed until `prisma generate` runs. After migration, these will auto-resolve.

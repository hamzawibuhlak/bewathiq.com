# Phase 32 â€” Verification & Deployment Walkthrough

## Ù…Ø§ ØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©

Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Phase 32ØŒ Ø§ÙƒØªØ´ÙÙ†Ø§ **Ù…Ø´ÙƒÙ„ØªÙŠÙ† Ø­Ø±Ø¬ØªÙŠÙ†**:

| Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | Ø§Ù„ØªØ£Ø«ÙŠØ± |
|---------|---------|
| [Softphone](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/components/call-center/Softphone.tsx#20-425) ØºÙŠØ± Ù…Ø¶Ø§Ù Ù„Ø£ÙŠ Layout | Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ±Ù‰ Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆÙ„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø¬Ø±Ø§Ø¡ Ù…ÙƒØ§Ù„Ù…Ø§Øª |
| [WhatsappConnect](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/components/whatsapp/WhatsappConnect.tsx#14-314) QR ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… | Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ø¨Ø± Ù…Ø³Ø­ QR |

## Ù…Ø§ ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡

### 1. [AppLayout.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/components/layout/AppLayout.tsx)
- Ø£Ø¶ÙÙ†Ø§ [Softphone](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/components/call-center/Softphone.tsx#20-425) ÙƒÙ€ lazy-loaded floating component
- ÙŠØ¸Ù‡Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª ÙƒØ²Ø± Ø¹Ø§Ø¦Ù…

```diff:AppLayout.tsx
import { useState, useEffect } from 'react';
import { Outlet } from 'react-router-dom';
import { useQueryClient } from '@tanstack/react-query';
import { cn } from '@/lib/utils';
import { Sidebar } from './Sidebar';
import { Header } from './Header';
import { useWebSocket } from '@/hooks/use-websocket';
import toast from 'react-hot-toast';

export function AppLayout() {
    const [isCollapsed, setIsCollapsed] = useState(false);
    const { subscribe, isConnected } = useWebSocket();
    const queryClient = useQueryClient();

    // Subscribe to real-time notifications
    useEffect(() => {
        if (!isConnected) return;

        const unsubscribeNotification = subscribe('notification', (data: unknown) => {
            const notification = data as { title?: string; message?: string; type?: string };
            
            // Refresh notifications in React Query
            queryClient.invalidateQueries({ queryKey: ['notifications'] });
            queryClient.invalidateQueries({ queryKey: ['notifications', 'unread-count'] });
            
            if (notification.title) {
                if (notification.type === 'ERROR') {
                    toast.error(notification.title, { duration: 5000 });
                } else if (notification.type === 'SUCCESS') {
                    toast.success(notification.title, { duration: 4000 });
                } else if (notification.type === 'WARNING') {
                    toast(notification.title, { icon: 'âš ï¸', duration: 5000 });
                } else {
                    toast(notification.title, { icon: 'ğŸ””', duration: 4000 });
                }
            }
        });

        const unsubscribeCaseUpdate = subscribe('case:update', () => {
            queryClient.invalidateQueries({ queryKey: ['cases'] });
        });

        const unsubscribeHearingUpdate = subscribe('hearing:update', () => {
            queryClient.invalidateQueries({ queryKey: ['hearings'] });
        });

        const unsubscribeWhatsApp = subscribe('whatsapp:message', (data: unknown) => {
            const msg = data as { direction?: string };
            queryClient.invalidateQueries({ queryKey: ['whatsapp', 'messages'] });
            if (msg.direction === 'INBOUND') {
                toast('Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯Ø©', { icon: 'ğŸ’¬' });
            }
        });

        const unsubscribeDocument = subscribe('document:upload', () => {
            queryClient.invalidateQueries({ queryKey: ['documents'] });
        });

        return () => {
            unsubscribeNotification();
            unsubscribeCaseUpdate();
            unsubscribeHearingUpdate();
            unsubscribeWhatsApp();
            unsubscribeDocument();
        };
    }, [isConnected, subscribe, queryClient]);

    return (
        <div className="min-h-screen bg-background" dir="rtl">
            {/* Sidebar */}
            <Sidebar isCollapsed={isCollapsed} onToggle={() => setIsCollapsed(!isCollapsed)} />

            {/* Header */}
            <Header isCollapsed={isCollapsed} />

            {/* Main Content */}
            <main
                className={cn(
                    'pt-16 min-h-screen transition-all duration-300',
                    isCollapsed ? 'mr-16' : 'mr-64'
                )}
            >
                <div className="p-6">
                    <Outlet />
                </div>
            </main>
        </div>
    );
}

export default AppLayout;
===
import { useState, useEffect, lazy, Suspense } from 'react';
import { Outlet } from 'react-router-dom';
import { useQueryClient } from '@tanstack/react-query';
import { cn } from '@/lib/utils';
import { Sidebar } from './Sidebar';
import { Header } from './Header';
import { useWebSocket } from '@/hooks/use-websocket';
import toast from 'react-hot-toast';

const Softphone = lazy(() => import('@/components/call-center/Softphone'));

export function AppLayout() {
    const [isCollapsed, setIsCollapsed] = useState(false);
    const { subscribe, isConnected } = useWebSocket();
    const queryClient = useQueryClient();

    // Subscribe to real-time notifications
    useEffect(() => {
        if (!isConnected) return;

        const unsubscribeNotification = subscribe('notification', (data: unknown) => {
            const notification = data as { title?: string; message?: string; type?: string };
            
            // Refresh notifications in React Query
            queryClient.invalidateQueries({ queryKey: ['notifications'] });
            queryClient.invalidateQueries({ queryKey: ['notifications', 'unread-count'] });
            
            if (notification.title) {
                if (notification.type === 'ERROR') {
                    toast.error(notification.title, { duration: 5000 });
                } else if (notification.type === 'SUCCESS') {
                    toast.success(notification.title, { duration: 4000 });
                } else if (notification.type === 'WARNING') {
                    toast(notification.title, { icon: 'âš ï¸', duration: 5000 });
                } else {
                    toast(notification.title, { icon: 'ğŸ””', duration: 4000 });
                }
            }
        });

        const unsubscribeCaseUpdate = subscribe('case:update', () => {
            queryClient.invalidateQueries({ queryKey: ['cases'] });
        });

        const unsubscribeHearingUpdate = subscribe('hearing:update', () => {
            queryClient.invalidateQueries({ queryKey: ['hearings'] });
        });

        const unsubscribeWhatsApp = subscribe('whatsapp:message', (data: unknown) => {
            const msg = data as { direction?: string };
            queryClient.invalidateQueries({ queryKey: ['whatsapp', 'messages'] });
            if (msg.direction === 'INBOUND') {
                toast('Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯Ø©', { icon: 'ğŸ’¬' });
            }
        });

        const unsubscribeDocument = subscribe('document:upload', () => {
            queryClient.invalidateQueries({ queryKey: ['documents'] });
        });

        return () => {
            unsubscribeNotification();
            unsubscribeCaseUpdate();
            unsubscribeHearingUpdate();
            unsubscribeWhatsApp();
            unsubscribeDocument();
        };
    }, [isConnected, subscribe, queryClient]);

    return (
        <div className="min-h-screen bg-background" dir="rtl">
            {/* Sidebar */}
            <Sidebar isCollapsed={isCollapsed} onToggle={() => setIsCollapsed(!isCollapsed)} />

            {/* Header */}
            <Header isCollapsed={isCollapsed} />

            {/* Main Content */}
            <main
                className={cn(
                    'pt-16 min-h-screen transition-all duration-300',
                    isCollapsed ? 'mr-16' : 'mr-64'
                )}
            >
                <div className="p-6">
                    <Outlet />
                </div>
            </main>

            {/* Softphone â€” floating WebRTC dialer (Phase 32) */}
            <Suspense fallback={null}>
                <Softphone />
            </Suspense>
        </div>
    );
}

export default AppLayout;
```

### 2. [WhatsAppSettingsPage.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/pages/settings/WhatsAppSettingsPage.tsx)
- Ø£Ø¶ÙÙ†Ø§ Ù‚Ø³Ù… "Ø±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ø¨Ø± QR Code" Ø£Ø³ÙÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cloud API
- Ø£Ø¶ÙÙ†Ø§ import Ù„Ù€ [WhatsappConnect](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/components/whatsapp/WhatsappConnect.tsx#14-314)

### 3. [WhatsappConnect.tsx](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/components/whatsapp/WhatsappConnect.tsx)
- Ø£Ø¶ÙÙ†Ø§ [useWhatsAppQR](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/hooks/use-websocket.ts#127-135) Ùˆ [useWhatsAppStatus](file:///Users/hamzabuhlakq/Downloads/succes-mark/projects-2026/wathiq%20system%20projec/watheeq-mvp/frontend/src/hooks/use-websocket.ts#136-144) hooks ÙƒÙ€ fallback
- Ø§Ù„Ø¢Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† `wsRef` prop Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ hooks Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©

## Ø§Ù„Ù†Ø´Ø±

```
âœ… TypeScript build â€” 0 errors
âœ… SCP upload â€” 635KB
âœ… Docker build â€” backend + frontend
âœ… All containers healthy:
   - watheeq_frontend_prod: Up (healthy)
   - watheeq_backend_prod:  Up (healthy)
   - watheeq_postgres_prod: Up 44h (healthy)
   - watheeq_redis_prod:    Up 44h (healthy)
```
